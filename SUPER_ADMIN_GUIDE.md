# Super Admin Role - Implementation Guide

## Обзор
Добавлена новая роль `super_admin` которая может делать всё то же, что и обычный админ, но пользователей с этой ролью нельзя удалить.

## Изменения в коде

### 1. Модель User (`models/user.py`)
- Добавлена новая роль `super_admin` в enum `UserRole`
- Роль располагается первой в списке для обозначения наивысшего приоритета

### 2. Админ роуты (`routes/admin.py`)
- **Защита от удаления**: Функция `delete_user` теперь проверяет роль пользователя и запрещает удаление супер админов
- **Новые эндпоинты**:
  - `PUT /admin/users/{user_id}/promote-to-super-admin` - повышение до супер админа
  - `PUT /admin/users/{user_id}/demote-from-super-admin` - понижение до обычного админа
  - `GET /admin/super-admins` - список всех супер админов
  - `GET /admin/stats/users-by-role` - статистика пользователей по ролям

### 3. Аутентификация (`routes/auth.py`)
- Супер админы теперь также получают админ токены при входе
- Обновлена проверка ролей в функции `login`

### 4. Зависимости (`core/dependencies.py`)
- Добавлена функция `get_super_admin_from_token` для будущих эндпоинтов, требующих супер админ права

### 5. Скрипт создания (`scripts/create_super_admin.py`)
- Новый скрипт для создания супер админ пользователей
- Использование: `python3 create_super_admin.py <username> <password> [email] [full_name]`

## API Эндпоинты

### Создание пользователя
`POST /admin/users`
- Теперь поддерживает роль `super_admin` в поле `role`
- Валидация обновлена для поддержки трёх ролей: `super_admin`, `admin`, `user`

### Удаление пользователя  
`DELETE /admin/users/{user_id}`
- ❌ **Блокирует удаление** пользователей с ролью `super_admin`
- Возвращает HTTP 403 с сообщением "Cannot delete users with super admin role"

### Повышение до супер админа
`PUT /admin/users/{user_id}/promote-to-super-admin`
- Меняет роль пользователя на `super_admin`
- Требует админ токен

### Понижение с супер админа
`PUT /admin/users/{user_id}/demote-from-super-admin`
- Меняет роль супер админа на обычного `admin`
- Проверяет, что пользователь действительно супер админ

### Список супер админов
`GET /admin/super-admins`
- Возвращает список всех пользователей с ролью `super_admin`

### Статистика по ролям
`GET /admin/stats/users-by-role`
- Показывает количество пользователей по каждой роли
- Включает как общий count, так и только активных пользователей

## Безопасность

### Защита от удаления
- Пользователи с ролью `super_admin` **не могут быть удалены** через API
- При попытке удаления возвращается ошибка 403

### Админ токены
- Супер админы получают те же админ токены, что и обычные админы
- Это позволяет им использовать все админ эндпоинты

## Миграция данных
- В данной реализации миграция базы данных не выполнялась
- При необходимости можно создать миграцию для добавления новой роли в enum
- Существующие пользователи останутся с их текущими ролями

## Использование

### Создание супер админа через скрипт:
```bash
cd /home/ec2-user/pandora_backend
python3 scripts/create_super_admin.py admin_user strong_password admin@example.com "Super Admin"
```

### Повышение существующего админа:
```bash
curl -X PUT "http://localhost:8000/admin/users/1/promote-to-super-admin" \
  -H "X-Admin-Token: your-admin-token"
```

### Проверка статистики ролей:
```bash
curl -X GET "http://localhost:8000/admin/stats/users-by-role" \
  -H "X-Admin-Token: your-admin-token"
```

## Примечания
- Супер админы имеют те же права доступа, что и обычные админы
- Единственное отличие - их нельзя удалить
- Рекомендуется иметь ограниченное количество супер админов для безопасности
